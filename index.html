<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot Builder + AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Save, Upload, Download, Plus, Trash2, 
            Smartphone, Zap, Image as ImageIcon, MessageSquare,
            ArrowRight, GripVertical, ExternalLink, RefreshCw, LayoutGrid, X, AlertCircle,
            Terminal, Sparkles, Settings, Loader2, Wand2
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- GEMINI API HELPER ---
        const generateContent = async (apiKey, prompt, systemInstruction = "") => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API Error");
                }

                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        // --- EXTRACTED COMPONENT TO FIX FOCUS BUG & IMMUTABILITY ---
        const ButtonEditor = ({ buttons, nodeList, currentNodeId, onChange }) => {
            const updateButton = (rowIndex, btnIndex, field, val) => {
                const newButtons = buttons.map(row => [...row]);
                if (!newButtons[rowIndex]) newButtons[rowIndex] = [];
                if (!newButtons[rowIndex][btnIndex]) newButtons[rowIndex][btnIndex] = {};
                
                const btn = newButtons[rowIndex][btnIndex];

                if (field === 'type') {
                    // Switch modes logic
                    if (val === 'url') {
                        delete btn.next;
                        delete btn.invoke;
                        delete btn.file_ids;
                        btn.url = "https://";
                    } else if (val === 'invoke') {
                        delete btn.url;
                        delete btn.next;
                        delete btn.file_ids;
                        btn.invoke = "my_function";
                    } else if (val === 'file') {
                        delete btn.url;
                        delete btn.next;
                        delete btn.invoke;
                        btn.file_ids = "";
                    } else {
                        delete btn.url;
                        delete btn.invoke;
                        delete btn.file_ids;
                        // Ensure 'next' exists for standard navigation
                        if (!btn.next) btn.next = currentNodeId || Object.keys(nodeList)[0] || "";
                    }
                } else {
                    // Normal field update
                    btn[field] = val;
                }

                // Cleanup: 'type' should NOT be in the final JSON object
                if (btn.type) delete btn.type;

                onChange(newButtons);
            };

            const addButton = (rowIndex) => {
                const newButtons = buttons.map(row => [...row]);
                newButtons[rowIndex].push({ label: "New Button", next: currentNodeId || Object.keys(nodeList)[0] || "" });
                onChange(newButtons);
            };

            const addRow = () => {
                const newButtons = buttons.map(row => [...row]);
                newButtons.push([{ label: "New Button", next: currentNodeId || Object.keys(nodeList)[0] || "" }]);
                onChange(newButtons);
            };

            const removeButton = (rowIndex, btnIndex) => {
                const newButtons = buttons.map(row => [...row]);
                newButtons[rowIndex].splice(btnIndex, 1);
                if (newButtons[rowIndex].length === 0) {
                    newButtons.splice(rowIndex, 1);
                }
                onChange(newButtons);
            };

            const removeRow = (rowIndex) => {
                const newButtons = buttons.map(row => [...row]);
                newButtons.splice(rowIndex, 1);
                onChange(newButtons);
            }

            return (
                <div className="space-y-4">
                    {buttons.map((row, rIndex) => (
                        <div key={rIndex} className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <div className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider flex justify-between items-center">
                                Row {rIndex + 1}
                                <button onClick={() => removeRow(rIndex)} className="text-red-400 hover:text-red-600 p-1">
                                    <Trash2 size={12} />
                                </button>
                            </div>
                            <div className="space-y-3">
                                {row.map((btn, bIndex) => (
                                    <div key={bIndex} className="flex flex-col gap-2 bg-white p-3 rounded border border-slate-200 shadow-sm">
                                        <div className="flex items-center gap-2">
                                            <input 
                                                type="text" 
                                                value={btn.label || ""} 
                                                onChange={(e) => updateButton(rIndex, bIndex, 'label', e.target.value)}
                                                className="flex-1 text-sm border border-slate-200 rounded px-2 py-1"
                                                placeholder="Button Label"
                                            />
                                            <button onClick={() => removeButton(rIndex, bIndex)} className="text-slate-400 hover:text-red-500 p-1">
                                                <X size={14} />
                                            </button>
                                        </div>
                                        <div className="flex gap-2">
                                            <select 
                                                className="text-xs border border-slate-200 rounded px-2 py-1 bg-slate-50"
                                                value={btn.url !== undefined ? 'url' : (btn.invoke !== undefined ? 'invoke' : (btn.file_ids !== undefined ? 'file' : 'next'))}
                                                onChange={(e) => updateButton(rIndex, bIndex, 'type', e.target.value)}
                                            >
                                                <option value="next">Go to Node</option>
                                                <option value="url">Open URL</option>
                                                <option value="invoke">Invoke Function</option>
                                                <option value="file">Send Files</option>
                                            </select>
                                            
                                            {btn.url !== undefined ? (
                                                <input 
                                                    type="text" 
                                                    value={btn.url}
                                                    onChange={(e) => updateButton(rIndex, bIndex, 'url', e.target.value)}
                                                    className="flex-1 text-xs border border-slate-200 rounded px-2 py-1"
                                                    placeholder="https://..."
                                                />
                                            ) : btn.invoke !== undefined ? (
                                                <input 
                                                    type="text" 
                                                    value={btn.invoke}
                                                    onChange={(e) => updateButton(rIndex, bIndex, 'invoke', e.target.value)}
                                                    className="flex-1 text-xs border border-slate-200 rounded px-2 py-1 font-mono text-purple-600"
                                                    placeholder="func_name"
                                                    title="Function to invoke"
                                                />
                                            ) : btn.file_ids !== undefined ? (
                                                <input 
                                                    type="text" 
                                                    value={btn.file_ids}
                                                    onChange={(e) => updateButton(rIndex, bIndex, 'file_ids', e.target.value)}
                                                    className="flex-1 text-xs border border-slate-200 rounded px-2 py-1 font-mono text-orange-600"
                                                    placeholder="file_123_abc,file_456_def"
                                                    title="Comma-separated file IDs"
                                                />
                                            ) : (
                                                <select 
                                                    value={btn.next || ""} 
                                                    onChange={(e) => updateButton(rIndex, bIndex, 'next', e.target.value)}
                                                    className="flex-1 text-xs border border-slate-200 rounded px-2 py-1"
                                                >
                                                    {!nodeList[btn.next] && <option value={btn.next || ""}>{btn.next} (Missing)</option>}
                                                    {Object.entries(nodeList).map(([id, n]) => (
                                                        <option key={id} value={id}>{n.name} ({id})</option>
                                                    ))}
                                                </select>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => addButton(rIndex)} className="w-full py-1 text-xs text-blue-500 font-medium hover:bg-blue-50 rounded border border-dashed border-blue-200">
                                    + Add Button to Row
                                </button>
                            </div>
                        </div>
                    ))}
                    <button onClick={addRow} className="w-full py-2 text-sm text-slate-500 font-medium hover:bg-slate-100 rounded border border-dashed border-slate-300 flex items-center justify-center gap-2">
                        <Plus size={16} /> Add New Row
                    </button>
                </div>
            );
        };

        const ConfigBuilder = () => {
            // --- INITIAL STATE ---
            const initialConfig = {
                commands: {
                    start: "home_screen"
                },
                nodes: {
                    home_screen: {
                        name: "Home Screen",
                        type: "image",
                        media_url: "https://images.unsplash.com/photo-1614680376593-902f74cf0d41?auto=format&fit=crop&w=600&q=80",
                        text: "<b>Welcome to the Bot Builder!</b>\n\nThis is a preview of your bot. Use the editor on the left to change this text, add buttons, or create new screens.",
                        buttons: [
                            [
                                { label: "ðŸ’Ž See Pricing", next: "pricing" },
                                { label: "ðŸ›  Features", next: "features" }
                            ],
                            [
                                { label: "ðŸŒ Visit Website", url: "https://google.com" }
                            ]
                        ]
                    },
                    pricing: {
                        name: "Pricing Page",
                        type: "text",
                        text: "Our plans are simple:\n\nâ€¢ Free: $0/mo\nâ€¢ Pro: $10/mo\nâ€¢ Enterprise: Contact us",
                        buttons: [
                            [ { label: "ðŸ”™ Back Home", next: "home_screen" } ]
                        ]
                    },
                    features: {
                        name: "Features List",
                        type: "text",
                        text: "We offer:\n- âš¡ Fast Performance\n- ðŸ”’ Secure Storage\n- ðŸ“ˆ Real-time Analytics",
                        invoke: "get_server_stats",
                        buttons: [
                            [ { label: "ðŸ”„ Refresh Stats", next: "features" } ],
                            [ { label: "ðŸ”™ Back", next: "home_screen" } ]
                        ]
                    }
                }
            };

            const [config, setConfig] = useState(initialConfig);
            const [selectedNodeId, setSelectedNodeId] = useState("home_screen");
            const [previewNodeId, setPreviewNodeId] = useState("home_screen");
            const [activeTab, setActiveTab] = useState("editor");
            const [jsonText, setJsonText] = useState(JSON.stringify(initialConfig, null, 2));
            const [jsonError, setJsonError] = useState(null);

            // AI State
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [showSettings, setShowSettings] = useState(false);
            const [isGeneratingNode, setIsGeneratingNode] = useState(false);
            const [isPolishing, setIsPolishing] = useState(false);
            const [showAiModal, setShowAiModal] = useState(false);
            const [aiPrompt, setAiPrompt] = useState("");

            useEffect(() => {
                if (activeTab !== 'json') {
                    setJsonText(JSON.stringify(config, null, 2));
                    setJsonError(null);
                }
            }, [config, activeTab]);

            // --- AI ACTIONS ---
            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem("gemini_api_key", key);
            };

            const handleGenerateNode = async () => {
                if (!apiKey) { setShowSettings(true); return; }
                if (!aiPrompt.trim()) return;

                setIsGeneratingNode(true);
                try {
                    const systemPrompt = `You are a helper for a Telegram Bot Builder. 
                    Create a JSON object representing a SINGLE bot node based on the user's description.
                    The JSON must adhere to this schema:
                    {
                        "name": "string (internal descriptive name)",
                        "type": "text" OR "image",
                        "text": "string (HTML allowed, use <b>, <i>, emojis)",
                        "media_url": "string (optional, valid image URL if type is image)",
                        "buttons": [[{"label": "string", "next": "string (target node ID placeholder)"}]]
                    }
                    For 'next' in buttons, use 'home_screen' or 'placeholder' if unsure.
                    If the user asks for a button that runs a function, use "invoke": "func_name" instead of "next" for that button.
                    Return ONLY the JSON object.`;

                    const nodeData = await generateContent(apiKey, aiPrompt, systemPrompt);
                    
                    const id = `node_${Date.now()}`;
                    setConfig(prev => ({
                        ...prev,
                        nodes: { ...prev.nodes, [id]: nodeData }
                    }));
                    setSelectedNodeId(id);
                    setPreviewNodeId(id);
                    setShowAiModal(false);
                    setAiPrompt("");
                } catch (error) {
                    alert("AI Generation Failed: " + error.message);
                } finally {
                    setIsGeneratingNode(false);
                }
            };

            const handlePolishText = async () => {
                if (!apiKey) { setShowSettings(true); return; }
                const currentNode = config.nodes[selectedNodeId];
                if (!currentNode.text) return;

                setIsPolishing(true);
                try {
                    const systemPrompt = `You are a professional copywriter for Telegram bots.
                    Rewrite the provided text to be engaging, concise, and user-friendly.
                    Use proper HTML tags (<b>, <i>) for formatting.
                    Add relevant emojis.
                    Return JSON: { "text": "your polished text here" }`;

                    const result = await generateContent(apiKey, currentNode.text, systemPrompt);
                    updateNode('text', result.text);
                } catch (error) {
                    alert("AI Polish Failed: " + error.message);
                } finally {
                    setIsPolishing(false);
                }
            };

            // --- JSON EDITOR ACTIONS ---
            const handleJsonChange = (e) => {
                const newVal = e.target.value;
                setJsonText(newVal);
                try {
                    const parsed = JSON.parse(newVal);
                    if (parsed.nodes && typeof parsed.nodes === 'object') {
                        setConfig(parsed);
                        setJsonError(null);
                        
                        if (!parsed.nodes[selectedNodeId]) {
                            const first = Object.keys(parsed.nodes)[0];
                            if (first) {
                                setSelectedNodeId(first);
                                setPreviewNodeId(first);
                            }
                        }
                    }
                } catch (err) {
                    setJsonError(err.message);
                }
            };

            // --- COMMAND ACTIONS ---
            const addCommand = () => {
                const newCmd = `cmd_${Object.keys(config.commands).length + 1}`;
                const firstNode = Object.keys(config.nodes)[0];
                setConfig(prev => ({
                    ...prev,
                    commands: { ...prev.commands, [newCmd]: firstNode }
                }));
            };

            const updateCommandKey = (oldKey, newKey) => {
                if (oldKey === newKey) return;
                const newCommands = {};
                Object.entries(config.commands).forEach(([k, v]) => {
                    if (k === oldKey) {
                        newCommands[newKey] = v;
                    } else {
                        newCommands[k] = v;
                    }
                });
                setConfig(prev => ({ ...prev, commands: newCommands }));
            };

            const updateCommandTarget = (key, newTarget) => {
                setConfig(prev => ({
                    ...prev,
                    commands: { ...prev.commands, [key]: newTarget }
                }));
            };

            const deleteCommand = (key) => {
                const newCommands = { ...config.commands };
                delete newCommands[key];
                setConfig(prev => ({ ...prev, commands: newCommands }));
            };

            // --- NODE ACTIONS ---
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (json.nodes) {
                            setConfig(json);
                            setJsonText(JSON.stringify(json, null, 2));
                            const firstNode = Object.keys(json.nodes)[0];
                            if (firstNode) {
                                setSelectedNodeId(firstNode);
                                setPreviewNodeId(firstNode);
                            }
                        } else {
                            alert("Invalid JSON format: Missing 'nodes' object.");
                        }
                    } catch (err) {
                        alert("Error parsing JSON file.");
                    }
                };
                reader.readAsText(file);
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "bot_config.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const copyToClipboard = () => {
                const text = `/update ${JSON.stringify(config)}`;
                navigator.clipboard.writeText(text).then(() => {
                    alert("Copied to clipboard! Paste this into your Telegram bot.");
                });
            };

            const addNode = () => {
                const id = `node_${Date.now()}`;
                const newNode = {
                    name: "New Screen",
                    type: "text",
                    text: "New screen content...",
                    buttons: []
                };
                setConfig(prev => ({
                    ...prev,
                    nodes: { ...prev.nodes, [id]: newNode }
                }));
                setSelectedNodeId(id);
                setPreviewNodeId(id);
            };

            const deleteNode = (id) => {
                if (Object.keys(config.nodes).length <= 1) {
                    alert("You must have at least one node.");
                    return;
                }
                if (confirm("Are you sure you want to delete this node?")) {
                    const newNodes = { ...config.nodes };
                    delete newNodes[id];
                    setConfig(prev => ({ ...prev, nodes: newNodes }));
                    if (selectedNodeId === id) {
                        const nextId = Object.keys(newNodes)[0];
                        setSelectedNodeId(nextId);
                        setPreviewNodeId(nextId);
                    }
                }
            };

            const updateNode = (field, value) => {
                setConfig(prev => ({
                    ...prev,
                    nodes: {
                        ...prev.nodes,
                        [selectedNodeId]: {
                            ...prev.nodes[selectedNodeId],
                            [field]: value
                        }
                    }
                }));
            };

            const updateNodeButtons = (newButtons) => {
                updateNode('buttons', newButtons);
            };

            // --- MAIN RENDER ---
            const currentNode = config.nodes[selectedNodeId];
            const previewNode = config.nodes[previewNodeId];

            return (
                <div className="h-screen w-full bg-slate-100 text-slate-800 flex flex-col font-sans relative">
                    
                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg font-bold flex items-center gap-2">
                                        <Settings size={20} className="text-slate-600" /> Settings
                                    </h2>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Gemini API Key</label>
                                    <input 
                                        type="password" 
                                        value={apiKey} 
                                        onChange={(e) => saveApiKey(e.target.value)}
                                        placeholder="AIzaSy..."
                                        className="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                    <p className="text-xs text-slate-500 mt-2">
                                        Key is stored locally in your browser. <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 hover:underline">Get key here</a>.
                                    </p>
                                </div>
                                <div className="flex justify-end">
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700"
                                    >
                                        Done
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* AI GENERATOR MODAL */}
                    {showAiModal && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-[500px] max-w-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg font-bold flex items-center gap-2 bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent">
                                        <Sparkles size={20} className="text-purple-500" /> Magic Screen Generator
                                    </h2>
                                    <button onClick={() => setShowAiModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Describe the screen you want:</label>
                                    <textarea 
                                        value={aiPrompt} 
                                        onChange={(e) => setAiPrompt(e.target.value)}
                                        placeholder="E.g. A support page with links to email and twitter, and a button to check server status."
                                        rows={4}
                                        className="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"
                                    />
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button 
                                        onClick={() => setShowAiModal(false)}
                                        className="text-slate-500 px-4 py-2 rounded text-sm font-medium hover:bg-slate-100"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={handleGenerateNode}
                                        disabled={isGeneratingNode || !aiPrompt.trim()}
                                        className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:opacity-90 disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {isGeneratingNode ? <><Loader2 size={16} className="animate-spin" /> Generating...</> : <><Sparkles size={16} /> Generate</>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <header className="h-16 bg-white border-b border-slate-200 px-6 flex items-center justify-between shrink-0 z-10">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                                <Zap size={20} fill="currentColor" />
                            </div>
                            <h1 className="font-bold text-lg text-slate-800 tracking-tight">Bot Builder <span className="text-xs font-normal text-slate-400 border border-slate-200 rounded px-2 py-0.5 ml-2">AI Edition âœ¨</span></h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={() => setShowSettings(true)} className={`p-2 rounded-full transition-colors ${!apiKey ? 'bg-red-100 text-red-500 animate-pulse-ring' : 'hover:bg-slate-100 text-slate-500'}`} title="Settings / API Key">
                                <Settings size={20} />
                            </button>
                            <div className="h-6 w-px bg-slate-200 mx-1"></div>
                            <label className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 rounded-md border border-slate-200 cursor-pointer transition-colors">
                                <Upload size={16} /> Import
                                <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                            </label>
                            <button onClick={handleExport} className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 rounded-md border border-slate-200 transition-colors">
                                <Download size={16} /> Export
                            </button>
                            <button onClick={copyToClipboard} className="flex items-center gap-2 px-4 py-1.5 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-md shadow-sm transition-colors">
                                <Save size={16} /> Copy
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        {/* LEFT SIDEBAR: LISTS */}
                        <aside className="w-80 bg-white border-r border-slate-200 flex flex-col shrink-0">
                            <div className="p-4 border-b border-slate-100">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Commands</h3>
                                    <button onClick={addCommand} className="p-1 hover:bg-slate-100 rounded text-blue-600 transition-colors" title="Add Command">
                                        <Plus size={16} />
                                    </button>
                                </div>
                                <div className="space-y-2">
                                    {Object.entries(config.commands).map(([cmd, target], idx) => (
                                        <div key={idx} className="flex flex-col bg-slate-50 p-2 rounded border border-slate-100 gap-2 group">
                                            <div className="flex items-center gap-2">
                                                <span className="text-slate-400 text-xs font-mono">/</span>
                                                <input 
                                                    type="text" 
                                                    className="flex-1 bg-transparent border-none text-sm font-mono text-blue-700 focus:ring-0 p-0"
                                                    value={cmd}
                                                    onChange={(e) => updateCommandKey(cmd, e.target.value)}
                                                />
                                                <button onClick={() => deleteCommand(cmd)} className="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity">
                                                    <Trash2 size={12} />
                                                </button>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <ArrowRight size={12} className="text-slate-300" />
                                                <select 
                                                    value={target}
                                                    onChange={(e) => updateCommandTarget(cmd, e.target.value)}
                                                    className={`flex-1 text-xs border rounded px-1 py-1 ${!config.nodes[target] ? 'border-red-300 bg-red-50 text-red-600' : 'bg-white border-slate-200'}`}
                                                >
                                                    {!config.nodes[target] && <option value={target}>{target} (Missing)</option>}
                                                    {Object.entries(config.nodes).map(([id, node]) => (
                                                        <option key={id} value={id}>{node.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Nodes (Screens)</h3>
                                    <div className="flex gap-1">
                                        <button 
                                            onClick={() => setShowAiModal(true)} 
                                            className="p-1 hover:bg-purple-50 text-purple-600 rounded transition-colors" 
                                            title="Magic Generate"
                                        >
                                            <Sparkles size={16} />
                                        </button>
                                        <button onClick={addNode} className="p-1 hover:bg-slate-100 rounded text-blue-600 transition-colors" title="Add Screen">
                                            <Plus size={16} />
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-1">
                                    {Object.entries(config.nodes).map(([id, node]) => (
                                        <button
                                            key={id}
                                            onClick={() => { setSelectedNodeId(id); setPreviewNodeId(id); setActiveTab('editor'); }}
                                            className={`w-full text-left px-3 py-2 rounded-md text-sm flex items-center justify-between group transition-colors ${selectedNodeId === id ? 'bg-blue-50 text-blue-700 font-medium' : 'text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <div className="flex items-center gap-2 truncate">
                                                {node.type === 'image' ? <ImageIcon size={14} className="opacity-50" /> : <MessageSquare size={14} className="opacity-50" />}
                                                <span className="truncate">{node.name}</span>
                                            </div>
                                            {selectedNodeId === id && (
                                                <div onClick={(e) => { e.stopPropagation(); deleteNode(id); }} className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                                                    <Trash2 size={12} />
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        {/* CENTER: EDITOR */}
                        <main className="flex-1 flex flex-col min-w-0 bg-white">
                            <div className="flex border-b border-slate-200">
                                <button onClick={() => setActiveTab('editor')} className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'editor' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>Visual Editor</button>
                                <button onClick={() => setActiveTab('json')} className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'json' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>Raw JSON</button>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {activeTab === 'editor' && currentNode ? (
                                    <div className="p-8 max-w-3xl mx-auto space-y-8">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Internal ID (Auto)</label>
                                                <input type="text" value={selectedNodeId} disabled className="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm text-slate-500 font-mono" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Screen Name (Admin Only)</label>
                                                <input type="text" value={currentNode.name} onChange={(e) => updateNode('name', e.target.value)} className="w-full bg-white border border-slate-200 focus:border-blue-500 outline-none rounded px-3 py-2 text-sm" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Message Type</label>
                                            <div className="flex gap-4">
                                                <label className={`flex items-center gap-2 p-3 rounded border cursor-pointer transition-colors flex-1 ${currentNode.type === 'text' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                    <input type="radio" name="type" checked={currentNode.type === 'text'} onChange={() => updateNode('type', 'text')} className="text-blue-600 focus:ring-blue-500" />
                                                    <MessageSquare size={16} /> <span className="text-sm font-medium">Text Only</span>
                                                </label>
                                                <label className={`flex items-center gap-2 p-3 rounded border cursor-pointer transition-colors flex-1 ${currentNode.type === 'image' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                    <input type="radio" name="type" checked={currentNode.type === 'image'} onChange={() => updateNode('type', 'image')} className="text-blue-600 focus:ring-blue-500" />
                                                    <ImageIcon size={16} /> <span className="text-sm font-medium">Image + Text</span>
                                                </label>
                                            </div>
                                        </div>
                                        {currentNode.type === 'image' && (
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Image URL</label>
                                                <div className="flex gap-2">
                                                    <input type="text" value={currentNode.media_url || ""} onChange={(e) => updateNode('media_url', e.target.value)} placeholder="https://example.com/image.jpg" className="flex-1 bg-white border border-slate-200 focus:border-blue-500 outline-none rounded px-3 py-2 text-sm" />
                                                    {currentNode.media_url && (
                                                        <div className="w-10 h-10 rounded border border-slate-200 bg-slate-50 shrink-0 overflow-hidden">
                                                            <img src={currentNode.media_url} className="w-full h-full object-cover" alt="Preview" />
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        <div>
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-xs font-bold text-slate-500 uppercase">Message Text (HTML Supported)</label>
                                                <button 
                                                    onClick={handlePolishText} 
                                                    disabled={isPolishing || !currentNode.text}
                                                    className="text-xs flex items-center gap-1 text-purple-600 hover:text-purple-700 font-medium disabled:opacity-50"
                                                >
                                                    {isPolishing ? <Loader2 size={12} className="animate-spin"/> : <Wand2 size={12} />}
                                                    Magic Polish
                                                </button>
                                            </div>
                                            <textarea value={currentNode.text} onChange={(e) => updateNode('text', e.target.value)} rows={6} className="w-full bg-white border border-slate-200 focus:border-blue-500 outline-none rounded px-3 py-2 text-sm font-sans" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Invoke Worker Function (On Load)</label>
                                            <div className="flex items-center gap-2">
                                                <RefreshCw size={14} className="text-slate-400" />
                                                <input type="text" value={currentNode.invoke || ""} onChange={(e) => updateNode('invoke', e.target.value)} placeholder="e.g. get_user_balance" className="flex-1 bg-white border border-slate-200 focus:border-blue-500 outline-none rounded px-3 py-2 text-sm font-mono" />
                                            </div>
                                            <p className="text-[10px] text-slate-400 mt-1">Runs when the screen loads. For button clicks, use the editor below.</p>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><LayoutGrid size={14} /> Buttons & Actions</label>
                                            <ButtonEditor 
                                                buttons={currentNode.buttons || []}
                                                nodeList={config.nodes}
                                                currentNodeId={selectedNodeId}
                                                onChange={updateNodeButtons}
                                            />
                                        </div>
                                    </div>
                                ) : activeTab === 'json' ? (
                                    <div className="p-4 h-full relative">
                                        {jsonError && (
                                            <div className="absolute top-2 right-6 bg-red-100 text-red-700 px-3 py-1 rounded text-xs flex items-center gap-2 border border-red-200 pointer-events-none">
                                                <AlertCircle size={12} /> {jsonError}
                                            </div>
                                        )}
                                        <textarea 
                                            className={`w-full h-full font-mono text-xs bg-slate-900 text-green-400 p-4 rounded-lg outline-none resize-none border-2 ${jsonError ? 'border-red-500' : 'border-transparent'}`} 
                                            value={jsonText}
                                            onChange={handleJsonChange}
                                            placeholder="Paste your JSON here..."
                                        />
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-400"><p>Select a node to edit</p></div>
                                )}
                            </div>
                        </main>

                        {/* RIGHT SIDEBAR: PREVIEW */}
                        <aside className="w-[400px] bg-slate-100 border-l border-slate-200 p-8 flex flex-col items-center justify-center shrink-0">
                            <div className="mb-4 flex items-center gap-2 text-slate-500 text-sm font-medium"><Smartphone size={16} /> Live Preview</div>
                            <div className="w-[320px] h-[640px] bg-white rounded-[40px] border-[8px] border-slate-800 shadow-2xl overflow-hidden relative flex flex-col">
                                <div className="h-6 bg-slate-800 w-full flex items-center justify-between px-6"><span className="text-[10px] text-white font-medium">9:41</span><div className="flex gap-1"><div className="w-2 h-2 rounded-full bg-white"></div><div className="w-2 h-2 rounded-full bg-white"></div></div></div>
                                <div className="h-12 bg-[#517DA2] flex items-center px-4 shrink-0 shadow-sm z-10">
                                    <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-xs mr-3">B</div>
                                    <div className="flex flex-col text-white"><span className="text-sm font-bold leading-tight">My Bot</span><span className="text-[10px] opacity-80 leading-tight">bot</span></div>
                                </div>
                                <div className="flex-1 bg-[#85A6C4] p-4 overflow-y-auto bg-cover bg-center bg-no-repeat" style={{ backgroundImage: 'url("https://web.telegram.org/img/bg_0.png")' }}>
                                    {previewNode && (
                                        <div className="flex flex-col gap-1 items-start max-w-[85%] animate-in fade-in slide-in-from-bottom-2 duration-300">
                                            <div className="bg-white rounded-lg rounded-tl-none shadow-sm overflow-hidden p-0 text-sm text-slate-800 relative group">
                                                {previewNode.type === 'image' && previewNode.media_url && (<div className="w-full aspect-video bg-slate-100"><img src={previewNode.media_url} className="w-full h-full object-cover" alt="Node Media" /></div>)}
                                                <div className="p-3 whitespace-pre-wrap leading-snug min-w-[120px]" dangerouslySetInnerHTML={{ __html: previewNode.text }} />
                                                <div className="px-3 pb-1 text-[10px] text-slate-400 text-right">9:42 AM</div>
                                            </div>
                                            {previewNode.buttons && previewNode.buttons.length > 0 && (
                                                <div className="w-full mt-1 space-y-1">
                                                    {previewNode.buttons.map((row, rIdx) => (
                                                        <div key={rIdx} className="flex gap-1">
                                                            {row.map((btn, bIdx) => (
                                                                <button key={bIdx} onClick={() => {
                                                                    if (btn.url) { window.open(btn.url, '_blank'); }
                                                                    else if (btn.invoke) { alert(`[Preview] Function invoked: ${btn.invoke}`); }
                                                                    else if (btn.file_ids) { alert(`[Preview] Would send files: ${btn.file_ids}`); }
                                                                    else if (btn.next && config.nodes[btn.next]) { setPreviewNodeId(btn.next); setSelectedNodeId(btn.next); }
                                                                }} className="flex-1 bg-[#5C88AA]/90 hover:bg-[#5C88AA] text-white text-xs font-semibold py-2.5 px-2 rounded backdrop-blur-sm shadow-sm active:scale-95 transition-all flex items-center justify-center gap-1">
                                                                    {btn.label} 
                                                                    {btn.url && <ExternalLink size={10} className="opacity-70" />}
                                                                    {btn.invoke && <Terminal size={10} className="opacity-70" />}
                                                                    {btn.file_ids && <Download size={10} className="opacity-70" />}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="h-12 bg-white border-t border-slate-200 flex items-center px-3 gap-3 shrink-0">
                                    <div className="w-6 h-6 rounded-full border-2 border-slate-300"></div><div className="h-8 flex-1 bg-slate-100 rounded-full"></div>
                                </div>
                            </div>
                            <div className="mt-6 text-center">
                                <p className="text-xs text-slate-400 max-w-[200px]">Click buttons in the phone preview to test your flow navigation.</p>
                                {previewNodeId !== "home_screen" && (<button onClick={() => { setPreviewNodeId("home_screen"); setSelectedNodeId("home_screen"); }} className="mt-3 text-xs text-blue-500 hover:underline">Reset Preview to Start</button>)}
                            </div>
                        </aside>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ConfigBuilder />);
    </script>
</body>
</html>
